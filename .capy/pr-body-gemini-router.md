# Gemini model router & fallback

This PR implements a robust Gemini router that defaults to Gemini 2.5 Pro and automatically falls back to Gemini 2.5 Flash when:
- The daily Pro limit is reached, or
- A 429 / quota error is returned.

Scope
- Applied to both Pro Search and Deep Research flows.
- UI displays a visible, dismissible banner when fallback occurs.

Key changes
- packages/ai/gemini/router.ts — New GeminiModelRouter using @google/generative-ai with per-day in-memory counters and quota-aware retry logic.
- packages/ai/gemini/index.ts — Helpers to generate streaming text and JSON objects via the router (with fallback reporting).
- packages/ai/workflow/tasks/* — Pro Search and Deep Research tasks now use the router helpers instead of hardcoded model strings.
- packages/common/components/thread/thread-item.tsx — Banner shown when fallback was used.
- packages/ai/workflow/utils.ts — updateObject now merges fields to avoid overwriting other task data.
- packages/ai/gemini/router.test.ts — Unit tests for router behavior (limits reset, fallback on limit and 429, no fallback on non-quota, both exhausted).
- .env.example — Added router env variables with defaults; supports GOOGLE_API_KEY or GEMINI_API_KEY.
- README.md — Added "Gemini model router & fallback" section.

Environment / Config
- GEMINI_PRIMARY_MODEL=gemini-2.5-pro
- GEMINI_FALLBACK_MODEL=gemini-2.5-flash
- GEMINI_PRIMARY_DAILY_LIMIT=50
- GEMINI_FALLBACK_DAILY_LIMIT=250
- GEMINI_ENABLE_FALLBACK=true
- GOOGLE_API_KEY (or GEMINI_API_KEY)

Acceptance criteria
- Pro Search and Deep Research route to 2.5 Pro by default and fall back to 2.5 Flash on daily limit or 429/quota errors.
- Visible banner appears only when fallback occurs.
- Env variables control behavior and can disable fallback.
- In-memory counters reset daily.
- No hard-coded model strings remain in affected flows.
- Unit tests cover router logic and edge cases.

Notes
- Counters are in-memory per instance (acceptable trade-off per request).
- For streaming, fallback transparently restarts the generation with the fallback model.


₍ᐢ•(ܫ)•ᐢ₎ Generated by [Capy](https://capy.ai) ([view task](https://capy.ai/project/42a73b29-fae3-41c7-a4ed-b5e60679cb02/task/dc121543-75fa-444e-b97f-836839ec3a02))