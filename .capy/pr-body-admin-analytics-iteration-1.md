# Admin — Analytics Iteration 1 (réels)

## Résumé
- Ajout d’un modèle MessageLog + index pour journaliser chaque requête IA (mode, provider, modèle, coût, latence, statut, code d’erreur).
- Remplacement de la santé simulée par des métriques réelles (latence moyenne/p95, taux d’erreur) calculées à partir des logs, par fournisseur et global.
- Extension des métriques avec l’usage par mode (totaux + séries temporelles), et nouvelles visualisations Recharts (aire empilée + camembert).
- Sélecteur de période global (24h / 7j / 30j) synchronisé entre KPIs, charts et santé; bornes TZ « Afrique/Djibouti » (UTC+03) cohérentes.
- UI accessible (FR tooltips, aria-labels), responsive (iPad 11”), alignée avec les patterns existants.

## Détails techniques
### Modèle & journalisation
- Prisma: `MessageLog` + index sur `createdAt`, `mode`, `provider`, `status`, `userId`.
- Log d’une entrée sur chaque requête IA après passage des checks (auth/crédits) avec latence, statut (`COMPLETED|ERROR|ABORTED`) et code d’erreur si présent.

### API
- `GET /api/admin/metrics` (window=`24h|7j|30j`) — bornage TZ UTC+03 :
  - Séries existantes conservées.
  - `usageByMode`: `totals`, `previousTotals`, `series: { dates, modes: Record<mode, number[]> }` (exclut `ABORTED`).
- `GET /api/admin/health` (window=`24h|7j|30j`) — à partir des `MessageLog`:
  - Par provider: `latencyAvgMs`, `latencyP95Ms` (COMPLETED), `errorRatePct` ((ERROR+ABORTED)/total), `keyPresent`, `status`.
  - Global: moyennes pondérées par volume + `worstStatus`.
  - Forme conservée, ajout de `previousOverall` pour deltas.
- Nouveau: `GET /api/admin/health/provider/[provider]` (window=`24h|7j|30j`):
  - Histogramme latence (buckets ms), percentiles p50/p90/p95/p99.
  - Répartition des erreurs: par statut et par `errorCode` (Top 10).
  - Séries temporelles par bin: `completed/errors/aborted`.

### Frontend
- KPIs (6): En ligne (moy), Total requêtes IA, p95 latence, Taux d’erreur, Suspensions, Suppressions. Deltas vs période précédente, sparklines quand pertinent.
- Charts Recharts:
  - Aire empilée: "Messages par mode" (séries binaires alignées sur `dates`).
  - Camembert: "Répartition actuelle par mode".
- Santé: tableau par provider avec lien "Détails" vers la vue dédiée `/admin/health/[provider]`.
- Sélecteur de période unique, FR tooltips, aria-labels, respect des styles (rounded-md border p-4, muted-foreground, couleurs sémantiques).

## Timezone
- Bornes calculées en UTC puis décalées de +180 min pour simuler « Afrique/Djibouti » (pas de DST). Séries `dates` alignées sur ces bornes.

## Contrat API
- Pas de breaking change: shapes actuels préservés; ajout de `usageByMode` (metrics) et `previousOverall` (health).

## Migration
- Nécessite migration Prisma (création `MessageLog`).

## Impact
- Visibilité réelle des performances et de la fiabilité IA, par provider et par mode d’utilisation.
- Base solide pour itérations suivantes (coût, pricing, shared tooltips, drill‑downs supplémentaires).


₍ᐢ•(ܫ)•ᐢ₎ Generated by [Capy](https://capy.ai) ([view task](https://capy.ai/project/572a92e5-84af-11f0-a94e-3eef481a796b/task/4d70dad6-99c8-4837-be01-9296f09e35e4))