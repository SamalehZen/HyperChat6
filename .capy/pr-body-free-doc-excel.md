# Image/PDF → Excel (free): PDF uploads + Tabula/Tesseract workflow + downloadable XLSX/CSV

Summary
- Remove paid OCR/API calls and credit usage from the existing Image → Excel mode by introducing a fully local, 100% free pipeline.
- Support both images and PDFs in the same existing mode (no new mode), with French and English OCR.
- Enforce sensible limits (≤10 pages per request) and stream clear progress/fallback updates to the chat.

Changes
- UI
  - Allow PDFs only in the existing Image → Excel mode. Keep image restrictions elsewhere.
  - Add PDF-specific size limit and clearer error messages for invalid/oversized files.
  - Update labels/tooltips to “Image/PDF → Excel (gratuit)” and mention “Images & PDFs supported (gratuit)”.
  - Show a small “PDF” tile in attachment bar for PDFs.
- Mode config & credits
  - Set SMART_PDF_TO_EXCEL credit cost to 0.
  - Mode display name updated to “Image/PDF → Excel (gratuit)”.
- Free workflow (no paid models): packages/ai/workflow/tasks/free-doc-to-excel.ts
  - Input: image/* and application/pdf attachments (data URLs coming from UI). Aggregate max 10 pages.
  - Digital vs scanned PDF detection via pdf-parse (text length + tabular heuristics).
  - Digital PDF extraction: Tabula (Java) ‘lattice’ first, fallback ‘stream’. On Tabula unavailability, fallback to pdfjs-dist position heuristics; finally OCR if needed.
  - Scanned PDFs and images: pdfjs-dist rasterization → tesseract.js OCR (eng+fra) → basic table reconstruction.
  - Outputs: consolidated CSV and XLSX (one sheet per page/table + Consolidated). Links are posted in chat.
  - Streaming progress messages show extraction mode and page counts.
- Router & registration
  - Route SMART_PDF_TO_EXCEL to the new free-doc-to-excel task.
- Download route
  - apps/web/app/api/exports/[file]/route.ts: streams XLSX/CSV from tmp dir with proper headers.
- Config & deps
  - .env.example: FREE_OCR_LANGUAGES=eng+fra, FREE_OCR_MAX_PAGES=10, FREE_OCR_TIMEOUT_MS=120000, optional TESSDATA_BASE and EXPORT_DIR.
  - packages/ai/package.json: add tesseract.js, tabula-js, xlsx, @napi-rs/canvas, pdf-parse, pdfjs-dist.

Impact
- The Image/PDF → Excel flow no longer consumes credits and calls no paid APIs.
- Graceful fallbacks: if Java/Tabula is missing or a PDF is encrypted, the task explains the fallback/error in the chat.
- Adds a minimal /api/exports endpoint to return binary outputs (XLSX/CSV) as downloads.

Testing
1) Switch to “Image/PDF → Excel (gratuit)”.
2) Upload a clean digital PDF with tables → expect “Tabula” path, then XLSX/CSV links.
3) Upload a scanned PDF or table images (French headers) → expect OCR path, fr/en recognized text, XLSX/CSV links.
4) Try >10 pages → should stop at 10 with a friendly note.
5) Try an encrypted/protected PDF → expect a clear error message.
6) Temporarily remove Java/Tabula → expect a fallback message and use pdfjs heuristics or OCR.

Why
- Provide reliable, cost-free table extraction for both PDFs and images, with bilingual OCR support, while keeping the UX inside the existing mode.


₍ᐢ•(ܫ)•ᐢ₎ Generated by [Capy](https://capy.ai) ([view task](https://capy.ai/project/572a92e5-84af-11f0-a94e-3eef481a796b/task/9350d489-12e0-4fec-a0fe-f17a9ea461f7))